<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Client Questionnaire</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .hidden {
        display: none;
      }

      .narrow-card {
        max-width: 720px;
        margin: 0 auto;
      }

      body.bg-light {
        background-color: #000 !important;
        color: #f6d376;
      }

      .card-body {
        background-color: #1a1a1a;
        color: #f6d376;
      }

      h3,
      h5,
      label,
      p,
      .modal-title,
      .form-label {
        color: #f6d376;
      }

      .form-control,
      .form-select {
        background-color: #fff;
        color: #000;
      }

      .btn-custom {
        background-color: #f6d376;
        border-color: #f6d376;
        color: #000;
      }

      .btn-custom:hover,
      .btn-custom:focus {
        background-color: #f2c95b;
        border-color: #f2c95b;
      }

      .spinner-border {
        color: #f6d376;
      }

      input.w-50,
      select.w-50 {
        max-width: 50% !important;
      }

      input.w-75,
      select.w-75 {
        max-width: 75% !important;
      }

      .input-short {
        max-width: 300px;
      }
      .input-medium {
        max-width: 420px;
      }
      .select-short {
        max-width: 300px;
      }
      .required-label::after {
        content: " *";
        color: red;
      }
      .modal-content {
        background-color: #fff;
        color: #000;
        border: 1px solid #000;
      }

      .modal-title {
        font-weight: bold;
        color: #28a745; /* зелёная галочка */
        text-align: center;
        width: 100%;
      }

      .modal-body {
        color: #000;
      }

      .modal-footer {
        background-color: #f4f4f4;
        border-top: none;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5 mb-5">
      <div class="card shadow narrow-card">
        <div class="card-body">
          <h3 class="text-center">CLIENT QUESTIONNAIRE</h3>
          <p class="text-center mb-4">(for Company Registration & KYC)</p>

          <!-- Основная форма -->
          <form id="questionnaire-form">
            <h5>1. PERSONAL INFORMATION</h5>
            <div class="mb-3">
              <label class="form-label required-label"
                >Full name (as in passport):</label
              >
              <input
                type="text"
                class="form-control"
                name="fullName"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label">Nationality:</label>
              <input
                type="text"
                class="form-control"
                name="nationality"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label">Date of birth:</label>
              <input
                type="date"
                class="form-control input-short"
                name="dob"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Place of birth (City, Country):</label
              >
              <input
                type="text"
                class="form-control"
                name="birthPlace"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label required-label"
                >Do you have E-residency?</label
              >
              <select
                class="form-select select-short"
                name="hasEResidency"
                id="hasEResidency"
                required
              >
                <option value="">Select...</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>

            <div id="if-no-eresidency" class="hidden">
              <div class="mb-3">
                <label class="form-label required-label"
                  >Personal ID code / Passport number:</label
                >
                <input
                  type="text"
                  class="form-control"
                  name="passportNumber"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label required-label"
                  >Passport issue and expiry date:</label
                >
                <div class="d-flex gap-2 flex-wrap">
                  <div>
                    <input
                      type="date"
                      class="form-control input-short"
                      name="passportIssue"
                      required
                      placeholder="Date of issue"
                    />
                    <small class="form-text text-muted">Date of issue</small>
                  </div>
                  <div>
                    <input
                      type="date"
                      class="form-control input-short"
                      name="passportExpiry"
                      required
                      placeholder="Expiry date"
                    />
                    <small class="form-text text-muted">Expiry date</small>
                  </div>
                </div>
              </div>
            </div>

            <div id="if-yes-eresidency" class="hidden">
              <div class="mb-3">
                <label class="form-label required-label"
                  >E-residency card number (Estonian ID):</label
                >
                <input
                  type="text"
                  class="form-control"
                  name="eresidencyID"
                  required
                />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label required-label"
                >Residential address:</label
              >
              <textarea
                class="form-control"
                name="residentialAddress"
                required
              ></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label required-label">Email address:</label>
              <input type="email" class="form-control" name="email" required />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Phone number (incl. country code):</label
              >
              <input type="tel" class="form-control input-short" name="phone" />
            </div>

            <h5 class="mt-4">2. OCCUPATION & BACKGROUND</h5>
            <div class="mb-3">
              <label class="form-label required-label"
                >Current occupation / job title:</label
              >
              <input
                type="text"
                class="form-control"
                name="occupation"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Company name (if self-employed or employed):</label
              >
              <input type="text" class="form-control" name="companyName" />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Brief description of your professional background:</label
              >
              <textarea class="form-control" name="background"></textarea>
            </div>

            <h5 class="mt-4">3. COMPANY INFORMATION</h5>
            <div class="mb-3">
              <label class="form-label required-label"
                >Proposed company name (1–3 variants):</label
              >
              <textarea
                class="form-control"
                name="companyNames"
                required
              ></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Company e-mail address:</label
              >
              <input
                type="email"
                class="form-control"
                name="companyEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Planned business activities:</label
              >
              <textarea
                class="form-control"
                name="businessActivities"
                required
              ></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Country(-ies) of your customers/clients:</label
              >
              <input
                type="text"
                class="form-control"
                name="customerCountries"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Will you have clients or partners from the EU?</label
              >
              <select
                class="form-select select-short"
                name="hasEUClients"
                required
              >
                <option value="">Select...</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Expected annual turnover (EUR):</label
              >
              <input
                type="number"
                class="form-control input-short"
                name="annualTurnover"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Expected monthly number of invoices (issued and
                received):</label
              >
              <input
                type="number"
                class="form-control input-short"
                name="monthlyInvoices"
                required
              />
            </div>

            <h5 class="mt-4">4. OWNERSHIP & MANAGEMENT</h5>
            <div class="mb-3">
              <label class="form-label required-label"
                >Will you be the sole shareholder and director?</label
              >
              <select
                class="form-select select-short"
                name="soleOwner"
                id="soleOwner"
                required
              >
                <option value="">Select...</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="mb-3 hidden" id="otherOwners">
              <label class="form-label required-label"
                >If not, please provide details of other
                shareholders/directors:</label
              >
              <textarea
                class="form-control"
                name="otherShareholders"
                required
              ></textarea>
            </div>

            <h5 class="mt-4">5. COMPLIANCE & KYC</h5>
            <div class="mb-3">
              <label class="form-label required-label"
                >Source of funds (personal savings, business income,
                etc):</label
              >
              <input
                type="text"
                class="form-control"
                name="sourceOfFunds"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Purpose of setting up the company in Estonia:</label
              >
              <textarea class="form-control" name="purpose" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Do you or any associated person hold a political position
                (PEP)?</label
              >
              <select class="form-select select-short" name="isPEP" required>
                <option value="">Select...</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >Are you or any related party under international
                sanctions?</label
              >
              <select
                class="form-select select-short"
                name="sanctions"
                required
              >
                <option value="">Select...</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>

            <h5 class="mt-4">6. DOCUMENTS TO ATTACH</h5>
            <div class="mb-3 hidden" id="eresidency-upload">
              <label class="form-label required-label"
                >A clear photo/scan of your e-residency card (front
                side):</label
              >
              <input
                type="file"
                name="eresidencyCard"
                class="form-control"
                accept="image/*,application/pdf"
              />
              <small class="form-text text-warning">Max file size: 5 MB</small>
            </div>
            <div class="mb-3">
              <label class="form-label required-label"
                >A clear scan of your passport or national ID:</label
              >
              <input
                type="file"
                name="passportScan"
                class="form-control"
                accept="image/*,application/pdf"
                required
              />
              <small class="form-text text-warning">Max file size: 5 MB</small>
            </div>

            <div class="d-grid mt-4">
              <button
                type="submit"
                class="btn btn-custom d-flex justify-content-center align-items-center"
              >
                <span>Submit</span>
                <div
                  class="spinner-border spinner-border-sm ms-2 d-none"
                  role="status"
                  id="form-spinner"
                >
                  <span class="visually-hidden">Loading...</span>
                </div>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ✅ Модальное окно после отправки -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content border-success">
          <div class="modal-header">
            <h5
              class="modal-title text-success text-center w-100"
              id="successModalLabel"
            >
              ✅ Form Submitted!
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Thank you! Your form has been submitted successfully.
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const form = document.getElementById("questionnaire-form");
      const submitBtn = form.querySelector('button[type="submit"]');
      const spinner = document.getElementById("form-spinner");

      function toggleRequired(selector, condition) {
        document.querySelectorAll(selector).forEach((el) => {
          if (condition) {
            el.setAttribute("required", "required");
          } else {
            el.removeAttribute("required");
          }
        });
      }

      document
        .getElementById("hasEResidency")
        .addEventListener("change", function () {
          const isYes = this.value === "Yes";

          document
            .getElementById("if-yes-eresidency")
            .classList.toggle("hidden", !isYes);
          document
            .getElementById("if-no-eresidency")
            .classList.toggle("hidden", isYes);
          document
            .getElementById("eresidency-upload")
            .classList.toggle("hidden", !isYes);

          toggleRequired(
            "input[name='passportNumber'], input[name='passportExpiry']",
            !isYes
          );
          toggleRequired("input[name='eresidencyID']", isYes);
        });

      document
        .getElementById("soleOwner")
        .addEventListener("change", function () {
          const isNo = this.value === "No";
          document
            .getElementById("otherOwners")
            .classList.toggle("hidden", !isNo);
          toggleRequired("textarea[name='otherShareholders']", isNo);
        });

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        submitBtn.disabled = true;
        spinner.classList.remove("d-none");

        const data = {};
        const elements = form.querySelectorAll("input, select, textarea");
        elements.forEach((el) => {
          if (el.type !== "file") {
            data[el.name] = el.value;
          }
        });

        const fileInputs = form.querySelectorAll('input[type="file"]');
        let filesToRead = fileInputs.length;
        const base64Files = [];

        const MAX_FILE_SIZE_MB = 5;
        const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;

        // ❌ Проверка размера всех файлов
        for (const input of fileInputs) {
          const file = input.files[0];
          if (file && file.size > MAX_FILE_SIZE) {
            alert(
              `❌ File "${file.name}" is too large. Max allowed size is ${MAX_FILE_SIZE_MB} MB.`
            );
            submitBtn.disabled = false;
            spinner.classList.add("d-none");
            return;
          }
        }

        if (filesToRead === 0) {
          processForm(data, base64Files);
          return;
        }

        fileInputs.forEach((input) => {
          const file = input.files[0];
          if (!file) {
            filesToRead--;
            if (filesToRead === 0) processForm(data, base64Files);
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const base64 = e.target.result.split(",")[1];
            base64Files.push({
              filename: file.name,
              mimeType: file.type,
              content: base64,
            });
            filesToRead--;
            if (filesToRead === 0) processForm(data, base64Files);
          };
          reader.readAsDataURL(file);
        });
      });

      function processForm(data, files) {
        google.script.run
          .withSuccessHandler(function (folderId) {
            // После успешной отправки формы, загружаем файлы
            google.script.run
              .withSuccessHandler(() => {
                const modal = new bootstrap.Modal(
                  document.getElementById("successModal")
                );
                modal.show();

                form.reset();
                submitBtn.disabled = false;
                spinner.classList.add("d-none");
              })
              .withFailureHandler(function (error) {
                alert("❌ File upload failed: " + error.message);
                submitBtn.disabled = false;
                spinner.classList.add("d-none");
              })
              .uploadFiles(folderId, files);
          })
          .withFailureHandler(function (error) {
            alert("❌ Form submission failed: " + error.message);
            submitBtn.disabled = false;
            spinner.classList.add("d-none");
          })
          .submitForm(data);
      }
    </script>
  </body>
</html>
